<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 25px; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header-subtitle { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .content { padding: 30px; }
        
        /* Панель управления */
        .control-panel { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #3498db; }
        .control-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .btn-control { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: #2c3e50; color: white; text-decoration: none; border-radius: 5px; }
        .btn-control:hover { background: #34495e; transform: translateY(-2px); }
        .btn-export { background: #27ae60; }
        .btn-export:hover { background: #219653; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }
        
        /* Фильтры */
        .filters { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .filter-group select, .filter-group input { padding: 10px; border: 2px solid #ddd; border-radius: 5px; }
        .btn-filter { background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-filter:hover { background: #2980b9; }
        
        /* Статистика */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); text-align: center; border-top: 4px solid; }
        .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .stat-value { font-size: 2em; font-weight: bold; }
        .stat-total { border-color: #3498db; }
        .stat-pending { border-color: #f1c40f; }
        .stat-confirmed { border-color: #2ecc71; }
        .stat-cancelled { border-color: #e74c3c; }
        
        /* Массовые действия */
        .bulk-actions { background: #e8f4fc; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .bulk-actions.active { display: block; }
        .bulk-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .bulk-btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .bulk-delete { background: #e74c3c; color: white; }
        .bulk-confirm { background: #2ecc71; color: white; }
        .bulk-cancel { background: #f39c12; color: white; }
        
        /* Таблица */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .select-cell { width: 40px; text-align: center; }
        
        /* Бейджи статусов */
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .badge-pending { background: #f1c40f; color: #000; }
        .badge-confirmed { background: #2ecc71; color: white; }
        .badge-cancelled { background: #e74c3c; color: white; }
        
        /* Кнопки действий */
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-action { padding: 5px 10px; border-radius: 5px; text-decoration: none; font-size: 0.8em; color: white; }
        .btn-edit { background: #3498db; }
        .btn-edit:hover { background: #2980b9; }
        .btn-delete { background: #e74c3c; }
        .btn-delete:hover { background: #c0392b; }
        .btn-status { background: #2ecc71; }
        .btn-status:hover { background: #27ae60; }
        
        /* Статистика по месяцам */
        .monthly-stats { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .stats-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .stat-item { display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px; }
        
        .empty-state { text-align: center; padding: 50px; color: #666; }
        .empty-state i { font-size: 3em; margin-bottom: 20px; opacity: 0.3; }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .filter-grid { grid-template-columns: 1fr; }
            table { font-size: 0.9em; }
            th, td { padding: 8px; }
            .control-buttons { flex-direction: column; }
            .btn-control { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cog"></i> Админ-панель</h1>
            <div class="header-subtitle">
                <p>Управление записями на экскурсии</p>
                <a href="/admin/logout" style="color: white; text-decoration: underline; font-size: 0.9em;">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </a>
            </div>
        </div>
        
        <div class="content">
            <!-- Панель управления -->
            <div class="control-panel">
                <h2><i class="fas fa-tachometer-alt"></i> Быстрые действия</h2>
                <div class="control-buttons">
                    <a href="/admin/export/csv" class="btn-control btn-export">
                        <i class="fas fa-file-csv"></i> Экспорт в CSV
                    </a>
                    <a href="/admin/export/json" class="btn-control">
                        <i class="fas fa-file-code"></i> Экспорт в JSON
                    </a>
                    <a href="/admin?status=pending" class="btn-control btn-warning">
                        <i class="fas fa-clock"></i> Ожидающие ({{ stats.pending }})
                    </a>
                    <a href="/admin?status=confirmed" class="btn-control">
                        <i class="fas fa-check-circle"></i> Подтвержденные ({{ stats.confirmed }})
                    </a>
                    <a href="/" class="btn-control">
                        <i class="fas fa-calendar"></i> Перейти к календарю
                    </a>
                    <a href="/admin/clear_all" class="btn-control btn-danger" onclick="return confirm('⚠️ Вы уверены что хотите очистить ВСЮ базу?')">
                        <i class="fas fa-trash"></i> Очистить базу
                    </a>
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="stats-grid">
                <div class="stat-card stat-total">
                    <h3>Всего записей</h3>
                    <div class="stat-value">{{ stats.total }}</div>
                </div>
                <div class="stat-card stat-pending">
                    <h3>Ожидают подтверждения</h3>
                    <div class="stat-value">{{ stats.pending }}</div>
                </div>
                <div class="stat-card stat-confirmed">
                    <h3>Подтверждено</h3>
                    <div class="stat-value">{{ stats.confirmed }}</div>
                </div>
                <div class="stat-card stat-cancelled">
                    <h3>Отменено</h3>
                    <div class="stat-value">{{ stats.cancelled }}</div>
                </div>
            </div>
            
            <!-- Фильтры -->
            <div class="filters">
                <h3><i class="fas fa-filter"></i> Фильтры</h3>
                <form method="GET" action="/admin" class="filter-grid">
                    <div class="filter-group">
                        <label>Статус:</label>
                        <select name="status">
                            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Все статусы</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидание</option>
                            <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Подтверждено</option>
                            <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Отменено</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Дата от:</label>
                        <input type="date" name="date_from" value="{{ date_from }}">
                    </div>
                    <div class="filter-group">
                        <label>Дата до:</label>
                        <input type="date" name="date_to" value="{{ date_to }}">
                    </div>
                    <div class="filter-group">
                        <label>Поиск:</label>
                        <input type="text" name="search" value="{{ search }}" placeholder="Школа, имя, телефон...">
                    </div>
                    <div class="filter-group" style="grid-column: span 2;">
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn-filter">
                                <i class="fas fa-search"></i> Применить фильтры
                            </button>
                            <a href="/admin" class="btn-filter" style="background: #95a5a6;">
                                <i class="fas fa-redo"></i> Сбросить
                            </a>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Массовые действия -->
            <div id="bulkActions" class="bulk-actions">
                <form method="POST" action="/admin/bulk_actions" id="bulkForm">
                    <p><strong>Выбрано записей: <span id="selectedCount">0</span></strong></p>
                    <div class="bulk-buttons">
                        <button type="submit" name="action" value="confirm" class="bulk-btn bulk-confirm">
                            <i class="fas fa-check"></i> Подтвердить выбранные
                        </button>
                        <button type="submit" name="action" value="cancel" class="bulk-btn bulk-cancel">
                            <i class="fas fa-times"></i> Отменить выбранные
                        </button>
                        <button type="submit" name="action" value="delete" class="bulk-btn bulk-delete" 
                                onclick="return confirm('Удалить выбранные записи?')">
                            <i class="fas fa-trash"></i> Удалить выбранные
                        </button>
                        <button type="button" onclick="deselectAll()" class="bulk-btn" style="background: #95a5a6; color: white;">
                            <i class="fas fa-times"></i> Снять выделение
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Таблица записей -->
            <h2><i class="fas fa-list"></i> Список записей</h2>
            {% if bookings %}
            <form id="tableForm">
                <table>
                    <thead>
                        <tr>
                            <th class="select-cell">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                            </th>
                            <th>ID</th>
                            <th>Дата экскурсии</th>
                            <th>Школа</th>
                            <th>Класс</th>
                            <th>Контактное лицо</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td class="select-cell">
                                <input type="checkbox" name="selected_ids" value="{{ booking['id'] }}" 
                                       class="row-selector" onchange="updateBulkActions()">
                            </td>
                            <td>{{ booking['id'] }}</td>
                            <td>
                                <strong>{{ booking['excursion_date'] }}</strong>
                                <br>
                                <small style="color: #666;">записано: {{ booking['booking_date'].strftime('%d.%m.%Y %H:%M') }}</small>
                            </td>
                            <td>
                                {{ booking['school_name'] }}
                                {% if booking['class_profile'] %}
                                <br><small>Профиль: {{ booking['class_profile'] }}</small>
                                {% endif %}
                            </td>
                            <td>{{ booking['class_number'] }}</td>
                            <td>
                                <strong>{{ booking['contact_person'] }}</strong>
                                <br>
                                <small>{{ booking['contact_phone'] }}</small>
                                <br>
                                <small>Ответственный: {{ booking['username'] }}</small>
                                <br>
                                <small>Участников: {{ booking['participants_count'] }}</small>
                                {% if booking['additional_info'] %}
                                <br>
                                <small style="color: #666;">{{ booking['additional_info'][:50] }}{% if booking['additional_info']|length > 50 %}...{% endif %}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if booking['status'] == 'pending' %}
                                    <span class="badge badge-pending">Ожидание</span>
                                {% elif booking['status'] == 'confirmed' %}
                                    <span class="badge badge-confirmed">Подтверждено</span>
                                {% elif booking['status'] == 'cancelled' %}
                                    <span class="badge badge-cancelled">Отменено</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="/admin/edit/{{ booking['id'] }}" class="btn-action btn-edit">
                                        <i class="fas fa-edit"></i> Редакт.
                                    </a>
                                    {% if booking['status'] != 'confirmed' %}
                                    <form action="/admin/update_status/{{ booking['id'] }}" method="POST" style="display: inline;">
                                        <input type="hidden" name="status" value="confirmed">
                                        <button type="submit" class="btn-action btn-status" style="border: none; cursor: pointer;">
                                            <i class="fas fa-check"></i> Подтв.
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% if booking['status'] != 'cancelled' %}
                                    <form action="/admin/update_status/{{ booking['id'] }}" method="POST" style="display: inline;">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button type="submit" class="btn-action" style="border: none; cursor: pointer; background: #f39c12; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                                            <i class="fas fa-times"></i> Отменить
                                        </button>
                                    </form>
                                    {% endif %}
                                    <form action="/admin/delete/{{ booking['id'] }}" method="POST" style="display: inline;" 
                                          onsubmit="return confirm('Удалить запись #{{ booking['id'] }}?')">
                                        <button type="submit" class="btn-action btn-delete" style="border: none; cursor: pointer;">
                                            <i class="fas fa-trash"></i> Удалить
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>Нет записей</h3>
                <p>По выбранным фильтрам записи не найдены</p>
                <a href="/admin" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; text-decoration: none; border-radius: 5px;">
                    Сбросить фильтры
                </a>
            </div>
            {% endif %}
            
            <!-- Статистика по месяцам -->
            {% if stats.monthly_stats %}
            <div class="monthly-stats">
                <h3><i class="fas fa-chart-bar"></i> Статистика по месяцам (последние 6 месяцев)</h3>
                <div class="stats-list">
                    {% for stat in stats.monthly_stats %}
                    <div class="stat-item">
                        <span>{{ stat.month.strftime('%B %Y') }}</span>
                        <span><strong>{{ stat.count }}</strong> записей</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Управление массовым выделением
        function toggleSelectAll(checkbox) {
            const selectors = document.querySelectorAll('.row-selector');
            selectors.forEach(s => s.checked = checkbox.checked);
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const selected = document.querySelectorAll('.row-selector:checked');
            const count = selected.length;
            const bulkDiv = document.getElementById('bulkActions');
            const countSpan = document.getElementById('selectedCount');
            
            countSpan.textContent = count;
            
            if (count > 0) {
                bulkDiv.classList.add('active');
                
                // Обновляем форму массовых действий
                const bulkForm = document.getElementById('bulkForm');
                const selectedIds = Array.from(selected).map(s => s.value);
                
                // Удаляем старые скрытые поля
                const oldInputs = bulkForm.querySelectorAll('input[name="selected_ids"]');
                oldInputs.forEach(i => i.remove());
                
                // Добавляем новые
                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selected_ids';
                    input.value = id;
                    bulkForm.appendChild(input);
                });
            } else {
                bulkDiv.classList.remove('active');
            }
        }
        
        function deselectAll() {
            document.querySelectorAll('.row-selector').forEach(s => s.checked = false);
            document.getElementById('selectAll').checked = false;
            updateBulkActions();
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', updateBulkActions);
    </script>
</body>
</html>